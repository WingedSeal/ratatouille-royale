import pygame
import pygame_gui
from .input_manager import InputManager
from .gesture_interpreter import GestureInterpreter

class VisualManager:
    def __init__(self, screen: pygame.display, input_manager: InputManager, gesture_interpreter: GestureInterpreter):
        self.screen = screen
        self.input_manager = input_manager
        self.gesture_interpreter = gesture_interpreter

        # Top-level pygame_gui manager
        self.gui_manager = pygame_gui.UIManager(screen.get_size())

        # Dictionary of pages, each page is a list of UI elements
        self.pages = {}
        self.active_page = None

    def add_page(self, name, elements):
        """Add a page with a list of pygame_gui elements"""
        self.pages[name] = elements

    def set_active_page(self, name):
        self.active_page = name

    def handle_events(self, events):
        """Process events and forward unconsumed ones to GestureInterpreter"""
        events = self.input_manager.update()
        unconsumed_events = []

        for event in events:
            # Send all events to the pygame_gui manager
            self.gui_manager.process_events(event)

            # Determine if event was consumed by a widget
            if not getattr(event, 'ui_element', False):
                unconsumed_events.append(event)

        # Forward remaining events to gestures
        if unconsumed_events:
            self.gesture_interpreter.handle_events(unconsumed_events)

    def update(self, dt):
        """Update UI manager and active page elements"""
        self.gui_manager.update(dt)

    def draw(self):
        """Draw active page elements"""
        self.gui_manager.draw_ui(self.screen)
